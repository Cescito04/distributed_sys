---
# Playbook Ansible pour d√©ployer ShopHub E-Commerce sur Ubuntu
# Usage: ansible-playbook -i inventory.ini deploy_app.yml

- name: D√©ployer ShopHub E-Commerce sur Kubernetes
  hosts: ecommerce_servers
  become: yes
  gather_facts: yes

  vars:
    k8s_type: "{{ deployment_type | default('k3s') }}"
    manifests_local_path: "{{ playbook_dir }}/../k8s"
    manifests_remote_path: "{{ k8s_manifests_path | default('/home/ubuntu/k8s') }}"
    namespace: "{{ app_namespace | default('ecommerce') }}"

  pre_tasks:
    - name: Afficher les informations de d√©ploiement
      debug:
        msg:
          - "üöÄ D√©ploiement de ShopHub E-Commerce"
          - "H√¥te cible: {{ ansible_host }}"
          - "Type K8s: {{ k8s_type }}"
          - "Namespace: {{ namespace }}"
          - "Manifests: {{ manifests_remote_path }}"

  roles:
    - role: install_docker
      tags: ['docker', 'install']
    
    - role: install_kubernetes
      tags: ['kubernetes', 'k8s', 'install']
    
    - role: deploy_app
      tags: ['deploy', 'app']

  post_tasks:
    - name: Afficher le r√©sum√© du d√©ploiement
      debug:
        msg:
          - "‚úÖ D√©ploiement termin√© avec succ√®s !"
          - "Namespace: {{ namespace }}"
          - "Pour acc√©der au frontend:"
          - "  kubectl port-forward -n {{ namespace }} service/frontend-service 3000:3000"
          - "  Puis ouvrir http://localhost:3000"
          - ""
          - "Credentials admin:"
          - "  Email: admin@example.com"
          - "  Password: admin123"

    - name: Sauvegarder les informations de d√©ploiement
      copy:
        content: |
          D√©ploiement ShopHub E-Commerce
          ================================
          
          Date: {{ ansible_date_time.date }} {{ ansible_date_time.time }}
          H√¥te: {{ ansible_host }}
          Type K8s: {{ k8s_type }}
          Namespace: {{ namespace }}
          
          Acc√®s:
            kubectl port-forward -n {{ namespace }} service/frontend-service 3000:3000
            http://localhost:3000
          
          Credentials:
            Email: admin@example.com
            Password: admin123
          
          Commandes utiles:
            kubectl get pods -n {{ namespace }}
            kubectl get services -n {{ namespace }}
            kubectl logs -n {{ namespace }} -l app=backend
        dest: "{{ manifests_remote_path }}/deployment_info.txt"
        mode: '0644'

