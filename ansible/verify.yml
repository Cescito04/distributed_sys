---
# Playbook de vÃ©rification du dÃ©ploiement
# Usage: ansible-playbook -i inventory.ini verify.yml

- name: VÃ©rifier le dÃ©ploiement ShopHub E-Commerce
  hosts: ecommerce_servers
  become: yes
  gather_facts: yes

  vars:
    namespace: "{{ app_namespace | default('ecommerce') }}"

  tasks:
    - name: "ğŸ“Š VÃ©rification de l'installation"
      debug:
        msg: "DÃ©but des vÃ©rifications..."

    - name: VÃ©rifier que Docker est installÃ©
      command: docker --version
      register: docker_check
      changed_when: false

    - name: VÃ©rifier que K3s est installÃ©
      command: kubectl version --client
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml
      register: kubectl_check
      changed_when: false

    - name: VÃ©rifier l'Ã©tat du cluster K3s
      command: kubectl get nodes
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml
      register: cluster_nodes
      changed_when: false

    - name: VÃ©rifier que le namespace existe
      command: kubectl get namespace {{ namespace }}
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml
      register: namespace_check
      changed_when: false

    - name: Obtenir l'Ã©tat de tous les pods
      command: kubectl get pods -n {{ namespace }}
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml
      register: pods_status
      changed_when: false

    - name: Compter les pods Running
      shell: kubectl get pods -n {{ namespace }} --no-headers | grep -c "Running" || echo "0"
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml
      register: running_pods
      changed_when: false

    - name: Compter les pods Ready
      shell: kubectl get pods -n {{ namespace }} --no-headers | grep -c "1/1" || echo "0"
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml
      register: ready_pods
      changed_when: false

    - name: Obtenir l'Ã©tat des services
      command: kubectl get services -n {{ namespace }}
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml
      register: services_status
      changed_when: false

    - name: Obtenir le NodePort du frontend
      shell: kubectl get service frontend-service -n {{ namespace }} -o jsonpath='{.spec.ports[0].nodePort}'
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml
      register: frontend_nodeport
      changed_when: false

    - name: Tester l'accÃ¨s au frontend
      uri:
        url: "http://localhost:{{ frontend_nodeport.stdout }}"
        method: GET
        status_code: 200
        timeout: 10
      register: frontend_access
      ignore_errors: yes

    - name: Tester l'accÃ¨s au backend API
      uri:
        url: "http://localhost:8000/api/v1/products/"
        method: GET
        status_code: 200
        timeout: 10
      register: backend_access
      ignore_errors: yes
      when: false  # DÃ©sactivÃ© car backend est ClusterIP

    - name: "ğŸ“Š Rapport de VÃ©rification"
      debug:
        msg:
          - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          - "ğŸ“Š RAPPORT DE VÃ‰RIFICATION SHOPHUB"
          - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          - ""
          - "ğŸ³ Docker: {{ 'InstallÃ© âœ…' if docker_check.rc == 0 else 'Non installÃ© âŒ' }}"
          - "   Version: {{ docker_check.stdout }}"
          - ""
          - "â˜¸ï¸  Kubernetes (K3s): {{ 'InstallÃ© âœ…' if kubectl_check.rc == 0 else 'Non installÃ© âŒ' }}"
          - "   Cluster: {{ cluster_nodes.stdout_lines[1] if cluster_nodes.stdout_lines|length > 1 else 'N/A' }}"
          - ""
          - "ğŸ“¦ Namespace: {{ 'Existe âœ…' if namespace_check.rc == 0 else 'N/A âŒ' }}"
          - ""
          - "ğŸ”„ Pods:"
          - "   Running: {{ running_pods.stdout }}/3"
          - "   Ready: {{ ready_pods.stdout }}/3"
          - ""
          - "ğŸŒ Services:"
          - "   CrÃ©Ã©s: {{ services_status.stdout_lines|length - 1 if services_status.stdout_lines else 0 }}"
          - "   Frontend NodePort: {{ frontend_nodeport.stdout }}"
          - ""
          - "ğŸ§ª Tests d'AccÃ¨s:"
          - "   Frontend: {{ 'Accessible âœ…' if frontend_access.status == 200 else 'En attente â³' }}"
          - ""
          - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          - "ğŸ“Š Score: {{ ready_pods.stdout }}/3 pods Ready"
          - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

    - name: Afficher les dÃ©tails des pods
      debug:
        msg: "{{ pods_status.stdout_lines }}"

    - name: Afficher les dÃ©tails des services
      debug:
        msg: "{{ services_status.stdout_lines }}"

